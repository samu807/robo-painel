
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel de Controle do Rob√¥</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 20px;
  }

  #videoContainer {
    width: 640px;
    max-width: 90%;
    height: 360px;
    margin: 0 auto 40px auto;
    display: block;
  }

  #videoContainer iframe {
    width: 100%;
    height: 100%;
    border: 2px solid #333;
    display: block;
  }

  .joystick {
    width: 200px;
    max-width: 80%;
    aspect-ratio: 1;
    background: #eee;
    border-radius: 50%;
    position: relative;
    margin-bottom: 10px;
  }

  #status, #statusPanTilt {
    margin-top: 5px;
    font-weight: bold;
  }

  button {
    margin-top: 10px;
    padding: 10px 20px;
    font-size: 16px;
    border-radius: 5px;
    cursor: pointer;
    border: none;
  }

  #btnShutdown {
    background-color: #e74c3c;
    color: white;
  }

  #btnShutdown:hover { background-color: #c0392b; }

  #btnDashboard {
    display: inline-block;
    margin-top: 10px;
    padding: 10px 20px;
    font-size: 16px;
    background-color: #3498db;
    color: white;
    text-decoration: none;
  }

  #btnDashboard:hover { background-color: #2980b9; }

  .control-container {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 60px;
    margin-bottom: 20px;
  }

  .control-column {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  #keyHint {
    margin-top: 10px;
    color: #555;
    font-size: 14px;
  }

  .pan-tilt-grid {
    display: grid;
    grid-template-columns: 60px 60px 60px;
    grid-template-rows: 60px 60px 60px;
    gap: 5px;
    justify-content: center;
    align-items: center;
  }

  .pan-tilt-grid button {
    background-color: #ddd;
    font-size: 18px;
  }

  .pan-tilt-grid button:hover {
    background-color: #bbb;
  }

  .center-empty {
    background: transparent;
    border: none;
    cursor: default;
  }
</style>
</head>
<body>

<h2>Painel de Controle do Rob√¥</h2>

<div id="videoContainer">
  <iframe src="https://robo.pedmv.online/cam1/" allowfullscreen></iframe>
</div>

<div class="control-container">
  <div class="control-column">
    <h3>Movimenta√ß√£o</h3>
    <div id="joystick" class="joystick"></div>
    <div id="status">Conectando...</div>
    <div id="keyHint">Use W, A, S, D (locomo√ß√£o) e as setas ‚Üë ‚Üì ‚Üê ‚Üí (Pan/Tilt)</div>
  </div>

  <div class="control-column">
    <h3>Pan/Tilt</h3>
    <div class="pan-tilt-grid">
      <div></div>
      <button id="btnUp">‚¨ÜÔ∏è</button>
      <div></div>
      <button id="btnLeft">‚¨ÖÔ∏è</button>
      <button class="center-empty" disabled></button>
      <button id="btnRight">‚û°Ô∏è</button>
      <div></div>
      <button id="btnDown">‚¨áÔ∏è</button>
      <div></div>
    </div>
    <div id="statusPanTilt">Posi√ß√£o Pan/Tilt: 90 / 90</div>
  </div>
</div>

<button id="btnShutdown">Desligar</button>
<br>
<a href="http://3.16.150.177:3000/public/dashboard/f2aca777-bf22-4dbb-a79a-afd9507b0716?tab=1-dados-gerais&data=2025-12-12" target="_blank" id="btnDashboard">Georreferenciamento</a>

<script>
// === CONEX√ÉO MQTT ===
const client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt');
client.on('connect', () => {
  document.getElementById('status').textContent = '‚úÖ Conectado ao HiveMQ!';
});
client.on('error', (err) => {
  document.getElementById('status').textContent = '‚ùå Erro: ' + err.message;
});

// === JOYSTICK ===
const joystickContainer = document.getElementById('joystick');
const joystick = nipplejs.create({
  zone: joystickContainer,
  mode: 'static',
  position: { left: '50%', top: '50%' },
  color: 'blue',
  size: 200
});

// Fun√ß√£o para converter √¢ngulo em dire√ß√£o (opcional, para status visual)
function angleToDirection(angle) {
  if (angle >= 45 && angle < 135) return 'frente';
  else if (angle >= 135 && angle < 225) return 'esquerda';
  else if (angle >= 225 && angle < 315) return 'tras';
  else return 'direita';
}

function enviarComando(direcao, velocidade) {
  // üîß Converte o comando textual para throttle/steer compat√≠vel com a Raspberry
  let throttle = 0, steer = 0;
  const v = velocidade / 100;
  switch (direcao) {
    case 'frente':  throttle = v; break;
    case 'tras':    throttle = -v; break;
    case 'esquerda': steer = -v; break;
    case 'direita':  steer = v; break;
    case 'parar':    throttle = 0; steer = 0; break;
  }

  // üîß Publica no t√≥pico correto e formato esperado
  client.publish('robo/command', JSON.stringify({ throttle, steer }));
}

// === JOYSTICK CONT√çNUO ===
joystick.on('move', (evt, data) => {
  if (!data.angle || !data.distance) return;

  // √Çngulo em radianos (converte graus ‚Üí radianos)
  const angleRad = data.angle.radian;

  // Normaliza a dist√¢ncia (m√°x. 100%)
  const distanceNorm = Math.min(data.distance / 75, 1);

  // Calcula throttle e steer cont√≠nuos
  // Dire√ß√£o do joystick: 0 rad = direita, œÄ/2 = frente, etc.
  const throttle = distanceNorm * Math.cos(angleRad - Math.PI / 2); // frente/tr√°s
  const steer = distanceNorm * Math.sin(angleRad - Math.PI / 2);    // esquerda/direita

  // Publica valores cont√≠nuos no MQTT
  client.publish('robo/command', JSON.stringify({
    throttle: parseFloat(throttle.toFixed(2)),
    steer: parseFloat(steer.toFixed(2))
  }));

  const velPercent = Math.round(distanceNorm * 100);
  document.getElementById('status').textContent =
    `Throttle: ${throttle.toFixed(2)} | Steer: ${steer.toFixed(2)} | Pot√™ncia: ${velPercent}%`;
});

joystick.on('end', () => {
  client.publish('robo/command', JSON.stringify({ throttle: 0, steer: 0 }));
  document.getElementById('status').textContent = 'üõë Parar';
});


// === TECLADO (WASD) ===
const velocidadeFixa = 35;
let teclaPressionada = null;
document.addEventListener('keydown', (event) => {
  if (event.repeat || teclaPressionada === event.key) return;
  teclaPressionada = event.key.toLowerCase();
  let direcao = null;
  switch (teclaPressionada) {
    case 'w': direcao = 'frente'; break;
    case 's': direcao = 'tras'; break;
    case 'd': direcao = 'esquerda'; break;
    case 'a': direcao = 'direita'; break;
    case ' ': direcao = 'parar'; break;
  }
  if (direcao) {
    const velocidade = (direcao === 'parar') ? 0 : velocidadeFixa;
    enviarComando(direcao, velocidade);
    document.getElementById('status').textContent =
      (direcao === 'parar') ? 'üõë Parar' : `üéÆ ${direcao.toUpperCase()} (Teclado) | Velocidade: ${velocidade}`;
  }
});

document.addEventListener('keyup', (event) => {
  teclaPressionada = null;
  if (['w','a','s','d'].includes(event.key.toLowerCase())) {
    enviarComando('parar', 0);
    document.getElementById('status').textContent = 'üõë Parar';
  }
});

// === PAN/TILT ===
let pan = 90;
let tilt = 90;
const passo = 15;
const statusPanTilt = document.getElementById('statusPanTilt');

function enviarPanTilt() {
  client.publish('robo/pan', String(pan));
  client.publish('robo/tilt', String(tilt));
  statusPanTilt.textContent = `Posi√ß√£o Pan/Tilt: ${pan} / ${tilt}`;
}

document.getElementById('btnUp').addEventListener('click', () => {
  tilt = Math.max(0, tilt - passo);
  enviarPanTilt();
});
document.getElementById('btnDown').addEventListener('click', () => {
  tilt = Math.min(180, tilt + passo);
  enviarPanTilt();
});

// üîÑ Invers√£o dos comandos esquerda/direita
document.getElementById('btnLeft').addEventListener('click', () => {
  pan = Math.min(180, pan + passo);  // antes diminu√≠a, agora aumenta
  enviarPanTilt();
});
document.getElementById('btnRight').addEventListener('click', () => {
  pan = Math.max(0, pan - passo);    // antes aumentava, agora diminui
  enviarPanTilt();
});

// Setas do teclado ‚Üí Pan/Tilt (tamb√©m invertido no eixo horizontal)
document.addEventListener('keydown', (event) => {
  switch (event.key) {
    case 'ArrowUp': tilt = Math.max(0, tilt - passo); enviarPanTilt(); break;
    case 'ArrowDown': tilt = Math.min(180, tilt + passo); enviarPanTilt(); break;
    case 'ArrowLeft': pan = Math.min(180, pan + passo); enviarPanTilt(); break; // invertido
    case 'ArrowRight': pan = Math.max(0, pan - passo); enviarPanTilt(); break;  // invertido
  }
});


// === DESLIGAR ===
document.getElementById('btnShutdown').addEventListener('click', () => {
  client.publish('robo/shutdown', 'shutdown');
  alert('‚ö†Ô∏è Comando de desligamento enviado!');
});
</script>

</body>
</html>

